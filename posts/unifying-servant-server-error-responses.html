<!DOCTYPE html>
<html lang="en">
  <head>
      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125893749-1"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'UA-125893749-1');
          </script>
    <title>Unifying Servant server error responses</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Epicallan page">
    <meta name="keywords" content="Haskell, Functional progarmming, FP">
    <meta name="author" content="Epicallan" />

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@epicallan" />
    <meta property="twitter:title" content="Epicallan - Unifying Servant server error responses" />
    <meta name="twitter:description" content="Accompanying blog post to Servant Errors wai-middleware Haskell library" />
    <meta name="twitter:image:src" content="https://lukwagoallan.comimages/logo-yellow.png" />
    <meta property="og:title" content="Epicallan - Unifying Servant server error responses" />
    <meta property="og:description" content="Accompanying blog post to Servant Errors wai-middleware Haskell library" />
    <meta property="og:site_name" content="Epicallan" />
    <meta property="og:image" content="https://lukwagoallan.comimages/logo-yellow.png" />

    <!-- Favicon -->
    <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/dracula.min.css" />
    <!-- Custom fonts for this template -->
    <link href="../css/font-awesome.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Lato" />
    <!-- Custom styles for this template -->
    <link href="../css/default.css" rel="stylesheet">
    <link href="../css/post.css" rel="stylesheet">
  </head>

  <body class="body-posts">

          <!-- Header -->
      <nav class="navbar navbar-inverse navbar-fixed-left leftmenu bg-primary">

            <div class="toc-zone pt-md-5">
                <div class="row">
                    <div class="col-md-12">
                        <h5 class="about-text">Contents</h5>
                        <div class="toc pt-md-2" id="main">
                            <ul>
<li><a href="#intro">Intro</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#servant-server-exceptions">Servant server Exceptions</a><ul>
<li><a href="#servant-server-error-categories">Servant server error categories</a></li>
<li><a href="#servant-server-error-handling">Servant server error handling</a></li>
<li><a href="#solution-with-servant-errors-middleware-library">Solution with Servant-Errors middleware library</a></li>
</ul></li>
</ul>
                        </div>
                    </div>
                </div>

            </div>

            <div class="pt-md-3 about-text">
                <div class="row justify-content-center pt-md-2">
                    <div class="col-md-12">
                        <h6><a href="../posts"> Posts </a></h6>
                    </div>
                </div>
                <div class="row justify-content-center pt-md-2">
                    <div class="col-md-12">
                        <h6><a href="../"> About me </a></h6>
                    </div>
                </div>

                <div class="row justify-content-center pt-md-2">
                    <div class="col-md-12">
                        <h6 class="text-center text-uppercase">Around the web</h6>
                    </div>
                </div>

                <div class="row justify-content-center pt-md-3 text-center">
                    <div class="col-md-12">
                            <ul class="list-inline mb-0 mx-auto">

                                <li class="list-inline-item my-auto">
                                    <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://github.com/epicallan" target="_blank">
                                    <i class="fa fa-fw fa-github"></i>
                                    </a>
                                </li>

                                <li class="list-inline-item my-auto">
                                    <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://twitter.com/epicallan" target="_blank">
                                    <i class="fa fa-fw fa-twitter"></i>
                                    </a>
                                </li>

                                <li class="list-inline-item my-auto">
                                    <a class="btn btn-outline-light btn-social text-center rounded-circle" href="https://www.linkedin.com/in/allan-lukwago" target="_blank">
                                        <i class="fa fa-fw fa-linkedin"></i>
                                        </a>
                                <li class="list-inline-item my-auto">


                                </ul>
                    </div>
                </div>
            </div>
      </nav>
      <div class="container info">
          <h2 class="text-center text-uppercase">Unifying Servant server error responses</h2>
          <div class="content">
          <div class="row post">
              <div class="col-12 post-body">
              <p class="lead">
                  <h2 id="intro">Intro<a href="#intro" class="anchor">ðŸ”—</a></h2>
<p>The blog post is a discussion about exceptions in Servant and the <code>servant-errors wai middleware</code> Haskell library, its purpose and implementation details.</p>
<p>Find library source code in the link below.</p>
<ul>
<li><a href="https://github.com/epicallan/servant-errors">epicallan/servant-errors</a></li>
</ul>
<h2 id="motivation">Motivation<a href="#motivation" class="anchor">ðŸ”—</a></h2>
<p>By default, when your servant server application experiences an internal exception during endpoint route resolution, e.g.Â request body decode errors. The server response is just plain text with a status code in the HTTP headers.</p>
<p>At the same time, if you donâ€™t write custom code to customise error responses for errors thrown within servant route handlers the default response is plain text with an HTTP content-type if set within <code>ServerError</code>.</p>
<p>With <code>servant-errors</code> library, you get a single interface to structure and encode your error responses in one place as <code>JSON</code> error response or any other preferred form.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">-- | A typical servant application is usually of this form</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-3"><a href="#cb1-3"></a>main <span class="ot">=</span> run <span class="dv">8001</span> (serve proxyApi handlers)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">-- | With servant-errors as error processing middleware, it's of this form.</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-7"><a href="#cb1-7"></a>main <span class="ot">=</span> run <span class="dv">8001</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>     <span class="op">$</span> errorMw <span class="op">@</span><span class="dt">JSON</span> <span class="op">@</span>[<span class="st">&quot;error&quot;</span>, <span class="st">&quot;status&quot;</span>]</span>
<span id="cb1-9"><a href="#cb1-9"></a>     <span class="co">-- ^ Structures error response as JSON objects</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>     <span class="co">-- with 'error' and 'status' strings as error object field keys</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>     <span class="co">-- note they can be changed to any other preferred strings.</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>     <span class="op">$</span> serve proxyApi handlers</span></code></pre></div>
<p><br /></p>
<h2 id="servant-server-exceptions">Servant server Exceptions<a href="#servant-server-exceptions" class="anchor">ðŸ”—</a></h2>
<hr />
<p><br /></p>
<h3 id="servant-server-error-categories">Servant server error categories<a href="#servant-server-error-categories" class="anchor">ðŸ”—</a></h3>
<p>Servant server errors can be thought to belong in three categories.</p>
<ul>
<li>A. Internal Exceptions thrown by Servant during API route resolution, e.g.Â Request body decode failures.</li>
<li>B. <code>ServerError</code> Exceptions thrown within API route handlers by a user.</li>
<li>C. IO asynchronous and impure synchronous Exceptions either thrown by non-total functions e.g.Â <code>head</code> or external IO failures such as DB failures.</li>
</ul>
<h3 id="servant-server-error-handling">Servant server error handling<a href="#servant-server-error-handling" class="anchor">ðŸ”—</a></h3>
<p>Errors of <code>category A and B</code> have servant framework handling support, while Errors of <code>category C</code> seep through the Servant framework layer to the underlying server running your servant application such as the warp-wai server.</p>
<p>The warp-wai server layer, unfortunately, doesnâ€™t have a way of passing <code>category C</code> errors to middleware for translation into an <code>HTTP 500 error response</code> as one would expect. <code>Wai</code> instead has a <code>setOnException</code> function which can be useful for logging purposes.</p>
<p>The <code>warp-wai</code> serverâ€™s stance is errors of <code>category C</code> must be handled at a framework level while Servant maintains that users should write handlers safe from such errors and possibly log them within a warp-wai server <code>setOnException</code> function if preferred.</p>
<p>One can read more <a href="https://github.com/haskell-servant/servant/issues/779">on this GitHub issue</a> and <a href="https://github.com/haskell-servant/servant/issues/1192">this</a>. However, the point of this article is not to debate the hows of dealing with errors of <code>category C</code> but rather to focus on HTTP server response structure of errors of <code>category A and B</code>.</p>
<p>The way Servant handles the formulation of HTTP responses of internal exceptions of category A has 2 major drawbacks in my opinion;</p>
<ul>
<li>A. The generated HTTP error response lacks a content type Header, i.e.Â JSON or Plain Text</li>
<li>B. There is no way one can customise the response body to alter its form.</li>
</ul>
<p>The lack of HTTP content headers forces clients to be less restrictive on which HTTP responses they accept, which has its pros and cons. I prefer to explicitly encode that a client only deals with one or two specific content types.</p>
<p>The lack of response body customisation also means clients have to accommodate the Servant HTTP error response body in its plain raw form even when it would have been better to have a custom form such as a JSON object.</p>
<h3 id="solution-with-servant-errors-middleware-library">Solution with Servant-Errors middleware library<a href="#solution-with-servant-errors-middleware-library" class="anchor">ðŸ”—</a></h3>
<p>It would have been preferable if the story for internal exception handling was a bit different, but that means making some changes within internal modules of the Servant API type combinators. So this leaves us with a warp-wai server middleware solution, that can help us customise specific servant-server responses.</p>
<p>The <a href="https://github.com/epicallan/servant-errors">servant-errors library</a> does precisely this. The logic is to customise responses with status codes higher than 200 while lacking HTTP content types into user preferred format.</p>
<p>A pleasant outcome of this approach is that it can subsequently format user thrown exceptions within servant route handlers such that they match the internal Servant error responses when they lack an HTTP content-type. The use of this library can, therefore, enable us to achieve uniform HTTP server error responses across an entire servant application.</p>
<p>Minimal Complete Sample usage example</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">-- | A greet message data type</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">newtype</span> <span class="dt">Greet</span> <span class="ot">=</span> <span class="dt">Greet</span> {<span class="ot"> msg ::</span> <span class="dt">Text</span> }</span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="kw">deriving</span> (<span class="dt">Generic</span>, <span class="dt">Show</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">-- servant application</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb2-6"><a href="#cb2-6"></a>main <span class="ot">=</span> run <span class="dv">8001</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="op">$</span> errorMw <span class="op">@</span><span class="dt">JSON</span> <span class="op">@</span>[<span class="st">&quot;error&quot;</span>, <span class="st">&quot;status&quot;</span>]</span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="co">-- ^ @JSON specifies content type encoding of errors</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="co">-- @[&quot;error&quot;, &quot;status&quot;] specifies error and code text label in resulting JSON error response</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="co">-- when an empty type level list parameter for 'errorMw' is specified</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="co">-- the 'HasErrorBody' instance defaults it to '@[&quot;error&quot;, &quot;status&quot;]' for JSON and PlainText instances</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="co">-- hence; errorMw @JSON @'[] == @JSON @[&quot;error&quot;, &quot;status&quot;]</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="op">$</span> serve api handler</span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="kw">where</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    handler <span class="ot">=</span> <span class="fu">return</span> <span class="op">.</span> <span class="fu">id</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    api <span class="ot">=</span> <span class="dt">Proxy</span> <span class="op">@</span>(<span class="dt">ReqBody</span> '[<span class="dt">JSON</span>] <span class="dt">Greet</span> <span class="op">:&gt;</span> <span class="dt">Post</span> '[<span class="dt">JSON</span>] <span class="dt">Greet</span>)</span></code></pre></div>
<p>If a user submits a wrong request body during an HTTP request, he receives a JSON encoded error response such as the one below. Using <code>servant-errors</code> library create an improvement in error responses over the default un-customisable raw text response.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="dv">400</span><span class="fu">,</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="st">&quot;Error in $: key </span><span class="ch">\&quot;</span><span class="st">msg</span><span class="ch">\&quot;</span><span class="st"> not present&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="fu">}</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="er">#</span> <span class="er">The</span> <span class="er">response</span> <span class="er">is</span> <span class="er">JSON</span> <span class="er">encoded</span> <span class="er">and</span> <span class="er">contains</span> <span class="er">an</span> <span class="er">HTTP</span> <span class="er">content-type</span> <span class="er">header</span> <span class="er">plus</span> <span class="er">a</span> <span class="er">status</span> <span class="er">code.</span></span></code></pre></div>
<p>Persons Matt also has a good read on <a href="https://www.parsonsmatt.org/2017/06/21/exceptional_servant_handling.html">Servant error exceptions</a> have a read on his blog</p>
                </p>
                <br>
                <p>Published on: September 24, 2019</p>
                <br>
                <p>
                    My blog is hosted on <a href="https://github.com/epicallan/epicallan.github.io" target="_blank">Github</a>. If you would like to leave a comment or report a problem please feel free to
                    leave one there.
                </p>
              </div>
          </div>
          </div>
      </div>


      <!-- Bootstrap core JavaScript -->
      <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"> </script>
      <script src="../js/post.js"> </script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
      <script>hljs.initHighlightingOnLoad()</script>
      <script async defer src="https://buttons.github.io/buttons.js"></script>
  </body>
</html>
